# Qwen3-TTS パラメータ詳細リファレンス

## generate_voice_design() の全パラメータ

```python
result = next(model.generate_voice_design(
    text="読み上げるテキスト",
    instruct="声質の説明",
    language="Japanese",
    max_tokens=150,
    temperature=0.65,
    repetition_penalty=1.15,
    top_k=35,
    top_p=0.92,
))
```

## パラメータ詳細

### text (必須)
読み上げるテキスト。

- **型**: `str`
- **推奨最大長**: 500文字程度
- **注意**: 長すぎるとmax_tokensに達して途中で切れる

### instruct (必須)
声質・話し方の説明テキスト。

- **型**: `str`
- **推奨最大長**: 200文字
- **効果**: 声の高さ、トーン、感情などを制御
- **制限**: 話速は制御不可（「早口」「ゆっくり」は効かない）

#### instruct例

```python
# 基本パターン
"落ち着いた女性の声"
"明るく元気な男性の声"

# 詳細パターン
"20代の明るく元気な女性の声、アナウンサーのように聞きやすい"
"40代の落ち着いた男性の声、ニュースキャスターのような話し方"

# 感情パターン
"優しく穏やかな女性の声"
"知的でクールな女性の声"
"力強く頼りがいのある男性の声"
```

### language
言語指定。

- **型**: `str`
- **値**: `"Japanese"`, `"English"`, `"Chinese"` 等
- **デフォルト**: なし（明示的に指定推奨）

### max_tokens

生成する最大トークン数。**音声長を直接制御**する最重要パラメータ。

- **型**: `int`
- **デフォルト**: `4096`（危険！使用非推奨）
- **推奨**: `150`（約12秒）
- **範囲**: `50` 〜 `2000`

#### max_tokens と音声長の関係

**計算式**: `音声長（秒）≈ max_tokens / 12.5`

| max_tokens | 音声長 | 用途 |
|------------|--------|------|
| 50 | 4秒 | 挨拶、相槌 |
| 75 | 6秒 | 短文 |
| 100 | 8秒 | 1-2文 |
| **150** | **12秒** | **標準（推奨）** |
| 200 | 16秒 | 長文 |
| 300 | 24秒 | パラグラフ |
| 500 | 40秒 | ナレーション |
| 1000 | 80秒 | 長尺 |
| 2000 | 160秒 | 最大推奨 |
| 4096 | 327秒 | 使用禁止 |

### temperature

サンプリング温度。出力の多様性を制御。

- **型**: `float`
- **デフォルト**: `0.9`
- **推奨**: `0.65`
- **範囲**: `0.1` 〜 `1.0`

| 値 | 効果 |
|----|------|
| 0.1-0.4 | 非常に安定、単調になりがち |
| 0.5-0.7 | 安定しつつ自然 |
| **0.65** | **推奨バランス** |
| 0.8-0.9 | 多様だが不安定になりやすい |
| 1.0 | 最大多様性、品質低下リスク |

### repetition_penalty

繰り返しペナルティ。同じフレーズの繰り返しを抑制。

- **型**: `float`
- **デフォルト**: `1.05`
- **推奨**: `1.15`
- **範囲**: `1.0` 〜 `2.0`

| 値 | 効果 |
|----|------|
| 1.0 | ペナルティなし |
| 1.05 | デフォルト（弱め） |
| **1.15** | **推奨** |
| 1.3+ | 強すぎると不自然に |
| 2.0 | 最大（過剰抑制リスク） |

### top_k

トップKサンプリング。次トークン候補をK個に制限。

- **型**: `int`
- **デフォルト**: `50`
- **推奨**: `35`
- **範囲**: `10` 〜 `100`

| 値 | 効果 |
|----|------|
| 10-20 | 非常に制限的、安定だが単調 |
| **35** | **推奨バランス** |
| 50 | デフォルト |
| 100 | 多様だが品質低下リスク |

### top_p

トップPサンプリング（nucleus sampling）。累積確率がPに達するまでのトークンから選択。

- **型**: `float`
- **デフォルト**: `1.0`
- **推奨**: `0.92`
- **範囲**: `0.5` 〜 `1.0`

| 値 | 効果 |
|----|------|
| 0.5-0.7 | 非常に保守的 |
| 0.8-0.9 | 安定 |
| **0.92** | **推奨** |
| 1.0 | 制限なし（デフォルト） |

## 環境別最適設定

### Mac M2 MLX（推奨設定）

```python
max_tokens=150,
temperature=0.65,
repetition_penalty=1.15,
top_k=35,
top_p=0.92,
```

**結果**: RTF 0.955（ほぼリアルタイム）

### RTX 3090 CUDA（バッチ処理）

バッチサイズ3が最適。

```python
# Gradio API経由
batch_texts = """テキスト1
テキスト2
テキスト3"""
```

**結果**: RTF 0.63（リアルタイムより速い）

## パラメータ調整フローチャート

```
問題発生
├── 音声が長すぎる → max_tokens を下げる
├── 繰り返しが発生 → repetition_penalty を上げる (1.15+)
├── 声質が不安定 → temperature を下げる (0.65)
├── 単調すぎる → temperature を上げる / top_k を上げる
└── 変な発音 → temperature を下げる / top_p を下げる
```

## 戻り値

```python
result.audio        # numpy.ndarray - 音声データ
result.sample_rate  # int - サンプルレート (24000Hz)
```

### 音声保存

```python
import soundfile as sf
sf.write("output.wav", result.audio, result.sample_rate)
```

### 音声長計算

```python
duration = len(result.audio) / result.sample_rate
print(f"音声長: {duration:.2f}秒")
```

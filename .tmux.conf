# macOS用のセキュリティ設定（Touch ID in tmux）
# set -g default-command "reattach-to-user-namespace -l $SHELL"
set -s escape-time 0

set-option -g prefix C-t
unbind-key C-b
bind-key C-t send-prefix

unbind-key z
bind-key t resize-pane -Z

bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

bind-key R source-file ~/.tmux.conf \; display-message "Config reloaded!"

bind-key -r C-h resize-pane -L 5
bind-key -r C-j resize-pane -D 5
bind-key -r C-k resize-pane -U 5
bind-key -r C-l resize-pane -R 5

bind-key a set-window-option synchronize-panes on
bind-key A set-window-option synchronize-panes off

set-window-option -g mode-keys vi

set-option -g mouse on
set -g focus-events on
set -s set-clipboard on
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e'"
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "~/bin/tmux-osc52.sh"
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "~/bin/tmux-osc52.sh"

unbind-key -T root DoubleClick1Pane
unbind-key -T root TripleClick1Pane
unbind-key -T copy-mode DoubleClick1Pane
unbind-key -T copy-mode TripleClick1Pane
unbind-key -T copy-mode-vi DoubleClick1Pane
unbind-key -T copy-mode-vi TripleClick1Pane

bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle

# Screenshot current pane (Shift+S) and open it immediately
bind-key -T prefix S run-shell 'f="$HOME/Downloads/tmux-#{session_name}-#{window_index}-#{pane_index}-#{?window_zoomed_flag,zoom,}$(date +%Y%m%d-%H%M%S).png"; mkdir -p "$HOME/Downloads"; ~/bin/tmux-pane-shot -p "#{pane_id}" -o "$f" && open -a Preview "$f"'

set-option -g base-index 1
set-window-option -g pane-base-index 1
set-option -g history-limit 3000
set-option -g default-terminal "tmux-256color"
# tmux / xterm クライアントにハイパーリンク機能を明示的に付与
set -g terminal-features 'tmux*:clipboard:ccolour:cstyle:focus:hyperlinks:title'
set -ag terminal-features 'xterm*:clipboard:ccolour:cstyle:focus:hyperlinks:title'
set -ag terminal-features 'screen*:title'
set -ag terminal-features 'rxvt*:ignorefkeys'
# Allow OSC 8 hyperlinks to reach the terminal (otherwise they show raw escape codes)
set -g allow-passthrough on
set-option -g status on
set-option -g status-interval 5
set-option -g status-justify centre
# Respect OSC 0/2 from applications; tmux will not overwrite terminal title
set-option -g set-titles off
# set-option -g set-titles-string "[tmux]#T \"#W\"(#I/#P)"

set-option -g automatic-rename on
set-option -g allow-rename off
# Allow OSC 0/2 sequences to set pane/terminal titles so they appear in pane_border_label
set-option -g allow-set-title on
set-option -g automatic-rename-format '#{pane_current_command} · #{b:pane_current_path}'

set -g pane-border-status top

set -g status-style fg=#d8f5c5,bg=#111812
set -g message-style fg=#111812,bg=#b8f171
set -g message-command-style fg=#111812,bg=#b8f171
set -g pane-border-style fg=#4e7a41
set -g pane-active-border-style fg=#b8f171,bold
set -g pane-border-lines double

set -g status-left-length 80
set -g status-left "#[fg=#111812,bg=#b8f171,bold] TMUX #[fg=#b8f171,bg=#4e7a41]#[fg=#d8f5c5,bg=#4e7a41] #S #[fg=#4e7a41,bg=#111812]#[fg=#9fe870] #h #[default]"

set -g status-right-length 60
set -g status-right '#(/Users/kazuph/.tmux/scripts/claude_status_segment.sh)#[fg=#111812,bg=#9fe870,bold] %Y-%m-%d %H:%M #[default]'

set-option -g window-status-separator ""
set-option -g window-status-format "#[fg=#5d7754,bg=#111812] #I #[fg=#c7f0a3]#W #{?window_flags,#[fg=#ffe07a]#{window_flags},}#[default]"
set-option -g window-status-current-format "#[fg=#111812,bg=#9fe870,bold] #I #[fg=#111812,bg=#9fe870,bold]#W #{?window_flags,#[fg=#111812,bg=#9fe870]#{window_flags},}#[fg=#9fe870,bg=#111812]#[default]"

set -g pane-border-format '#[fg=#8ccf78]#{?pane_active,#[fg=#b8f171]#[bold],}#{?@pane_marker, #[fg=#ffe07a]#{@pane_marker},} #[fg=#60785a]#(/Users/kazuph/.tmux/scripts/pane_border_label.sh "#{pane_width}" "#{pane_pid}" "#{pane_tty}" "#{pane_current_path}" "#{b:pane_current_path}" "#{pane_current_command}" "#{pane_title}" "#{pane_id}")#{?@git_branch, #[fg=#60785a](#{@git_branch}),} #[default]'

# --- Plugins ------------------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @resurrect-dir '~/.tmux/resurrect'
set -g @continuum-save-interval '15'
set -g @continuum-restore 'on'

run '~/.tmux/plugins/tpm/tpm'

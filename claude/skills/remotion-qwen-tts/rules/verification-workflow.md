# 検証ワークフロー完全ガイド

## 検証の重要性

**検証なしに「完了」と報告してはならない。**

動画生成は以下の問題が発生しやすい：
- 音声が途切れる
- 末尾に長い無音
- 口パクがずれる
- セリフと字幕が一致しない

これらは目視・自動検証なしには発見できない。

## 検証フェーズ一覧

```
┌─────────────────────────────────────────────────────────────────┐
│                    検証フェーズ                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  【検証1】個別音声検証 ─────────────────────────────────────────│
│     └─ verify-voices.py                                         │
│        ├─ Whisperで文字起こし                                   │
│        ├─ 元テキストとの類似度計算                              │
│        └─ 70%未満は警告                                        │
│                                                                  │
│  【検証2】動画音声検証 ─────────────────────────────────────────│
│     └─ analyze-video-audio.py                                   │
│        ├─ 動画から音声抽出                                      │
│        ├─ 無音区間検出                                         │
│        └─ 末尾無音チェック                                     │
│                                                                  │
│  【検証3】目視確認 ─────────────────────────────────────────────│
│     └─ open out/video.mp4                                       │
│        ├─ セリフが最後まで再生される                            │
│        ├─ 口パクが自然                                         │
│        └─ 字幕とキャラクターが正しい                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 検証1: 個別音声検証

### 目的

- 生成された音声が元テキストと一致しているか確認
- 音声の途切れや欠損を検出

### 実行方法

```bash
.venv/bin/python ~/.claude/skills/remotion-qwen-tts/scripts/verify-voices.py
```

### 出力例

```
音声検証スクリプト（Whisper文字起こし）
============================================================

スクリプトデータを読み込んでいます...
  12件のセリフを検出

音声を検証しています...
------------------------------------------------------------

  [01] zundamon ✅ 類似度: 92.5%
      元テキスト: やっほー！ずんだもんなのだ！今日はすごい...
      文字起こし: やっほー！ずんだもんなのだ！今日はすごい...

  [02] metan ✅ 類似度: 88.3%
      元テキスト: あら、ずんだもん。何かしら？そんなに興奮...
      文字起こし: あら、ずんだもん。何かしら？そんなに興奮...

============================================================
検証結果サマリー
============================================================
  検証ファイル数: 12
  平均類似度: 85.9%

✅ すべての音声が正常に検証されました！
```

### 判断基準

| 類似度 | 判定 | アクション |
|--------|------|-----------|
| 90%+ | 優秀 | そのまま使用 |
| 70-90% | 許容 | 確認推奨 |
| 50-70% | 警告 | 再生成検討 |
| 50%未満 | 失敗 | 再生成必須 |

### 低類似度の原因

1. **max_tokensが短すぎる**: 音声が途切れている
2. **テキストが長すぎる**: モデルの限界
3. **英語混じり**: カタカナに変換すべき

## 検証2: 動画音声検証

### 目的

- 動画全体の無音区間を検出
- 末尾の無音問題を発見
- セリフ途切れの兆候を検出

### 実行方法

```bash
.venv/bin/python ~/.claude/skills/remotion-qwen-tts/scripts/analyze-video-audio.py out/video.mp4
```

### 出力例

```
動画音声解析スクリプト
============================================================

対象: out/video.mp4

音声を抽出しています...
音声を解析しています...

------------------------------------------------------------
解析結果
------------------------------------------------------------
  動画の長さ: 87.85秒
  最後の音声: 85.50秒
  末尾の無音: 2.35秒

検出された無音区間（0.5秒以上）: 24箇所
  📍 0.8秒 〜 1.4秒 (0.6秒)
  📍 2.4秒 〜 3.7秒 (1.3秒)
  ...

============================================================
診断結果
============================================================
✅ 問題は検出されませんでした！
   末尾無音: 2.35秒（許容範囲）
```

### 判断基準

| 末尾無音 | 判定 | アクション |
|----------|------|-----------|
| 2秒未満 | OK | 問題なし |
| 2-3秒 | 許容 | 許容範囲 |
| 3-10秒 | 問題 | pauseAfter/余白確認 |
| 10秒以上 | 重大 | playbackRate二重調整疑い |

### 問題発見時の対処

| 問題 | 対処 |
|------|------|
| 末尾10秒以上の無音 | Root.tsxのplaybackRate調整確認 |
| 中盤に長い無音 | pauseAfterの値を確認 |
| セリフ間が短すぎる | pauseAfterを増やす |

## 検証3: 目視確認

### 目的

- 自動検証で見つからない問題を発見
- 最終的な品質確認

### 実行方法

```bash
open out/video.mp4
```

### チェックリスト

- [ ] セリフが最後まで再生される
- [ ] 口パクが音声と同期している
- [ ] 末尾に不自然な無音がない
- [ ] 字幕が正しく表示される
- [ ] キャラクターの切り替えが自然
- [ ] アニメーションが正しく動作

## 検証失敗時のフロー

```
検証失敗
    │
    ├─ 個別音声検証で失敗
    │   └─ generate-voices-qwen.py を再実行
    │      - max_tokensを増やす
    │      - テキストを短くする
    │      - 英語をカタカナに変換
    │
    ├─ 動画音声検証で失敗
    │   ├─ 末尾無音10秒以上
    │   │   └─ Root.tsx/Main.tsxのplaybackRate調整確認
    │   ├─ 末尾無音3-10秒
    │   │   └─ pauseAfter/余白を減らす
    │   └─ セリフが切れている
    │       └─ 二重playbackRate調整を確認
    │
    └─ 目視確認で失敗
        ├─ 口パクがずれている
        │   └─ mouth-data生成のFPS設定確認
        ├─ 字幕がおかしい
        │   └─ displayText設定確認
        └─ アニメーションがおかしい
            └─ Remotionコンポーネント確認
```

## 検証完了条件

以下すべてを満たすまで「完了」と報告してはならない：

1. **verify-voices.py**: 平均類似度70%以上
2. **analyze-video-audio.py**: 末尾無音3秒未満
3. **目視確認**: すべてのチェック項目がOK

```
┌─────────────────────────────────────────────────────────────────┐
│                    完了報告の条件                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ✅ verify-voices.py で平均類似度70%以上                        │
│  ✅ analyze-video-audio.py で末尾無音3秒未満                    │
│  ✅ open out/video.mp4 で目視確認完了                           │
│  ✅ セリフが途切れていない                                      │
│  ✅ 口パクが自然                                                │
│                                                                  │
│  すべてパスして初めて「完了」と報告できる                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```
